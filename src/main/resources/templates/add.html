<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ä¸°ç™»å†œæˆ·ä¸Šé“¾å½•å…¥</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(180deg, #f4fff2, #e2fbe5);
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #34a853;
            color: white;
            padding: 16px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 20px; margin: 0; }
        header .user-info { font-size: 15px; }
        header .user-info a {
            color: white;
            text-decoration: none;           /* å»æ‰ä¸‹åˆ’çº¿ */
            margin-left: 10px;
            font-weight: bold;
        }
        header .user-info a:hover {
            text-decoration: none;           /* æ‚¬åœæ—¶ä¹Ÿä¸æ˜¾ç¤º */
            color: #d9ffd9;                  /* å¯é€‰ï¼šé¼ æ ‡æ‚¬åœæ—¶é¢œè‰²å˜äº® */
        }
        main {
            display: flex; flex-direction: column; align-items: center; padding: 50px 20px;
        }
        .form-card {
            background: white; padding: 30px 40px; border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1); width: 450px;
        }
        .form-card h2 { text-align: center; color: #2e8b57; margin-bottom: 25px; }
        input, textarea {
            width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 15px;
        }
        button {
            width: 100%; background-color: #34a853; color: white; border: none; border-radius: 8px;
            padding: 12px; font-size: 16px; cursor: pointer; transition: 0.3s;
        }
        button:hover { background-color: #2e8b57; }
        .qrcode { margin-top: 30px; text-align: center; }
        .qrcode img { margin-top: 15px; border: 2px solid #34a853; border-radius: 10px; }
        .muted { color: #666; font-size: 14px; }
        .alert { margin-top: 12px; padding: 10px 12px; border-radius: 8px; }
        .alert-success { background: #e9f7ef; color: #1e7e34; border: 1px solid #cdebd8; }
        .alert-error { background: #fdecea; color: #a4262c; border: 1px solid #f5c2c7; }
        .code-badge {
            font-family: monospace; padding: 6px 8px; background: #f8f9fa;
            border: 1px solid #e9ecef; border-radius: 6px;
        }
        .copy-btn {
            margin-left: 10px; padding: 6px 10px; border-radius: 6px; border: none;
            background: #34a853; color: #fff; cursor: pointer;
        }
    </style>

</head>
<body>
<header>
    <h1>ğŸŒ¾ ä¸°ç™»å†œæˆ·ä¸Šé“¾ç³»ç»Ÿ</h1>
    <div class="user-info">
        ğŸ‘¨â€ğŸŒ¾ æ¬¢è¿ï¼Œ
        <span th:text="${session.user != null ? session.user.username : 'æœªç™»å½•'}"></span>
        ï½œ <a href="/api/qrcode/history">æŸ¥çœ‹å†å²</a>
        ï½œ <a href="/verify">é˜²ä¼ªéªŒè¯</a>
        ï½œ <a href="/index">é€€å‡ºç™»å½•</a>
    </div>
</header>

<main>
    <div class="form-card">
        <h2>ğŸ“ å†œäº§å“æº¯æºä¿¡æ¯å½•å…¥</h2>

        <!-- è¡¨å• -->
        <form id="uploadForm">
            <input type="text" id="productId" name="productId" placeholder="äº§å“ç¼–å·ï¼ˆå¦‚ï¼šAPPLE-20251019ï¼‰" required />
            <input type="text" id="farmer" name="farmer"
                   placeholder="å†œæˆ·å§“å"
                   th:value="${session.user != null ? session.user.username : ''}"
                   required readonly />
            <input type="text" id="action" name="action" placeholder="å†œäº‹æ“ä½œï¼ˆå¦‚ï¼šé‡‡æ‘˜ã€è¿è¾“ï¼‰" required />
            <input type="text" id="location" name="location" placeholder="æ“ä½œåœ°ç‚¹" required />
            <textarea id="description" name="description" placeholder="è¯¦ç»†æè¿°ï¼ˆå¦‚ï¼šé‡‡æ‘˜è‡ªç¦å»ºå¹³å’Œæœå›­ï¼‰" rows="3" required></textarea>
            <button type="submit" id="submitBtn">ğŸ”— ä¸Šé“¾è®°å½•</button>
            <div id="submitMsg" class="muted" style="margin-top:8px;"></div>
        </form>

        <!-- ç»“æœå±•ç¤º -->
        <div class="qrcode" id="qrcodeContainer">
            <h3>ç”Ÿæˆçš„äº§å“è¿½æº¯äºŒç»´ç ä¸ä¿¡æ¯</h3>
            <div id="qrcodeResult"></div>
        </div>

        <p class="muted" style="margin-top:16px;">
            æç¤ºï¼šæäº¤åç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨é“¾ä¸Šè®°å½•ï¼Œå¹¶ç”Ÿæˆè¿½æº¯äºŒç»´ç ä¸é˜²ä¼ªç ã€‚
        </p>
    </div>
</main>

<script>
    (function () {
        const form = document.getElementById("uploadForm");
        const result = document.getElementById("qrcodeResult");
        const msg = document.getElementById("submitMsg");
        const submitBtn = document.getElementById("submitBtn");

        function setLoading(loading) {
            submitBtn.disabled = loading;
            submitBtn.textContent = loading ? "æäº¤ä¸­..." : "ğŸ”— ä¸Šé“¾è®°å½•";
        }

        form.addEventListener("submit", async function (event) {
            event.preventDefault();
            setLoading(true);
            msg.className = "muted";
            msg.textContent = "";
            result.innerHTML = "";

            try {
                const formData = new FormData(form);

                // æäº¤åˆ° /api/trace/addï¼ˆåç«¯è¿”å› JSONï¼šstatus/antiFakeCode/traceUrl/qrBase64ï¼‰
                const resp = await fetch("/api/trace/add", {
                    method: "POST",
                    body: formData
                });

                const json = await resp.json().catch(() => null);

                if (!resp.ok || !json || json.status !== "success") {
                    const err = (json && (json.message || json.error)) || "ä¸Šé“¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—";
                    throw new Error(err);
                }

                const productId = json.productId;
                const antiFake  = json.antiFakeCode || "";
                const traceUrl  = json.traceUrl;
                const qrBase64  = (json.qrBase64 || "").startsWith("data:image")
                    ? json.qrBase64
                    : ("data:image/png;base64," + (json.qrBase64 || ""));

                // äºŒç»´ç 
                const img = document.createElement("img");
                img.src = qrBase64;
                img.alt = "äº§å“è¿½æº¯äºŒç»´ç ";
                img.width = 180;

                // é“¾æ¥
                const linkP = document.createElement("p");
                linkP.className = "mt-2";
                linkP.innerHTML = `è·³è½¬é“¾æ¥ï¼š<a href="${traceUrl}" target="_blank" rel="noopener noreferrer">${traceUrl}</a>`;

                // é˜²ä¼ªç  + å¤åˆ¶
                const codeDiv = document.createElement("div");
                codeDiv.className = "mt-2";
                codeDiv.innerHTML = `
        <strong>é˜²ä¼ªç ï¼š</strong>
        <span id="antiFakeCodeText" class="code-badge">${antiFake}</span>
        <button id="copyCodeBtn" class="copy-btn">å¤åˆ¶é˜²ä¼ªç </button>
      `;

                result.appendChild(img);
                result.appendChild(linkP);
                result.appendChild(codeDiv);

                document.getElementById("copyCodeBtn").addEventListener("click", function () {
                    const code = document.getElementById("antiFakeCodeText").innerText.trim();
                    navigator.clipboard.writeText(code)
                        .then(() => alert("é˜²ä¼ªç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"))
                        .catch(() => alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š" + code));
                });

                msg.className = "alert alert-success";
                msg.textContent = ` ä¸Šé“¾æˆåŠŸï¼äº§å“ç¼–å·ï¼š${productId}`;

                // å¦‚éœ€æ¸…ç©ºè¡¨å•ï¼Œå–æ¶ˆæ³¨é‡Šï¼š
                // form.reset();
                // document.getElementById("farmer").value = document.querySelector("span[th\\:text]").innerText || ""; // è‹¥éœ€ä¿ç•™ç™»å½•ç”¨æˆ·å

            } catch (e) {
                console.error(e);
                msg.className = "alert alert-error";
                msg.textContent = " " + (e.message || "ä¸Šé“¾å¤±è´¥");
            } finally {
                setLoading(false);
            }
        });
    })();
</script>

</body>
</html>
